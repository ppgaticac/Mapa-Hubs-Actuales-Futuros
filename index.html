<!DOCTYPE html>
<html>
<head>
    <title>Integración Dinámica de Google Maps</title>
    <style>
        /* Agregar estilos CSS necesarios */
        #map {
            height: 80%;
        }
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #search-box {
            width: 300px;
            margin-top: 10px;
        }
        #distance-list {
            margin-top: 10px;
        }
        .distance-item {
            padding: 5px;
        }
        .green-bg {
            background-color: #d4edda;
        }
        .red-bg {
            background-color: #f8d7da;
        }
        #result-list {
            max-height: 200px;
            overflow-y: auto;
            background-color: white;
            border: 1px solid #ccc;
            padding: 10px;
        }
        .result-item {
            cursor: pointer;
            margin-bottom: 5px;
        }
        .result-item:hover {
            background-color: #f0f0f0;
        }
    </style>
</head>
<body>
    <input id="search-box" type="text" placeholder="Buscar...">
    <button id="reset-button">Reiniciar</button>
    <div id="result-list"></div>
    <div id="distance-list"></div>
    <div id="map"></div>

    <script>
        let mapa;
        let marcadores = [];
        let ventanaInfo = new google.maps.InfoWindow();
        let servicioDirecciones = new google.maps.DirectionsService();
        let renderizadorDirecciones = new google.maps.DirectionsRenderer();
        let circuloBusqueda;

        const hubs = [
            { lat: -33.509915, lng: -70.650638, nombre: "Ciudad del niño", direccion: "Gran Av. José Miguel Carrera 6150, 8930520 San Miguel, Región Metropolitana", tipo: "futuro" },
            { lat: -33.524596, lng: -70.598747, nombre: "Florida center", direccion: "Av. Vicuña Mackenna Ote. 6100, 8242155 La Florida, Región Metropolitana", tipo: "futuro" },
            { lat: -33.501710, lng: -70.662125, nombre: "Portal el Llano", direccion: "Llano Subercaseaux, 8910339 San Miguel, Región Metropolitana", tipo: "futuro" },
            { lat: -33.444121, lng: -70.649597, nombre: "Alto San Francisco", direccion: "San Francisco 75, Santiago, Región Metropolitana", tipo: "futuro" },
            { lat: -33.457415, lng: -70.649070, nombre: "Nathaniel Cox", direccion: "Nataniel Cox 620, 8331081 Santiago, Región Metropolitana", tipo: "futuro" },
            { lat: -33.456594, lng: -70.648503, nombre: "Vicuña Mackenna", direccion: "Av. Vicuña Mackenna 665, 8330435 Santiago, Región Metropolitana", tipo: "futuro" },
            { lat: -33.464472, lng: -70.620384, nombre: "Ñuble", direccion: "Av. Vicuña Mackenna 1700, Santiago, Ñuñoa, Región Metropolitana", tipo: "futuro" },
            { lat: -33.422366, lng: -70.650869, nombre: "Independencia", direccion: "Av. Independencia 565, 8380538 Independencia, Región Metropolitana", tipo: "futuro" },
            { lat: -33.402900, lng: -70.579174, nombre: "Parque Arauco", direccion: "Av. Pdte. Kennedy 5413, 7550000 Las Condes, Región Metropolitana", tipo: "activo" },
            { lat: -33.465957, lng: -70.699735, nombre: "Espacio Urbano Las Rejas", direccion: "Av. María Rozas Velásquez 73, 9170428 Santiago, Estación Central, Región Metropolitana", tipo: "activo" }
        ];

        function agregarMarcadoresHubs() {
            hubs.forEach(ubicacion => {
                const marcador = new google.maps.Marker({
                    position: { lat: ubicacion.lat, lng: ubicacion.lng },
                    map: mapa,
                    title: ubicacion.nombre,
                    label: ubicacion.nombre,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: ubicacion.tipo === 'activo' ? 'green' : 'red',
                        fillOpacity: 1,
                        strokeWeight: 1,
                        strokeColor: 'black'
                    },
                    animation: google.maps.Animation.DROP
                });

                marcador.addListener('click', () => {
                    ventanaInfo.setContent(`<div><strong>${ubicacion.nombre}</strong><br>${ubicacion.direccion}</div>`);
                    ventanaInfo.open(mapa, marcador);
                });

                marcadores.push(marcador);
            });
        }

        function inicializarMapa() {
            // Inicializar el mapa
            mapa = new google.maps.Map(document.getElementById('map'), {
                center: { lat: -33.4489, lng: -70.6693 },
                zoom: 13
            });

            // Agregar marcadores de hubs
            agregarMarcadoresHubs();
            renderizadorDirecciones.setMap(mapa);

            const input = document.getElementById('search-box');
            const searchBox = new google.maps.places.SearchBox(input);

            mapa.controls[google.maps.ControlPosition.TOP_CENTER].push(input);

            searchBox.addListener('places_changed', () => {
                const places = searchBox.getPlaces();

                if (places.length === 0) {
                    return;
                }

                // Limpiar marcadores anteriores y lista de distancias
                marcadores.forEach(marcador => marcador.setMap(null));
                const listaDistancias = document.getElementById('distance-list');
                listaDistancias.innerHTML = '';
                const listaResultados = document.getElementById('result-list');
                listaResultados.innerHTML = '';

                places.forEach(lugar => {
                    if (!lugar.geometry) {
                        return;
                    }

                    const ubicacionLugar = lugar.geometry.location;

                    // Agregar marcador de la ubicación buscada
                    const marcador = new google.maps.Marker({
                        position: ubicacionLugar,
                        map: mapa,
                        title: lugar.name || 'Ubicación buscada',
                        label: lugar.name || 'Ubicación buscada',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 10,
                            fillColor: 'blue',
                            fillOpacity: 1,
                            strokeWeight: 1,
                            strokeColor: 'black'
                        },
                        animation: google.maps.Animation.BOUNCE
                    });

                    marcadores.push(marcador);

                    // Dibujar un círculo alrededor de la ubicación buscada
                    if (circuloBusqueda) {
                        circuloBusqueda.setMap(null);
                    }
                    circuloBusqueda = new google.maps.Circle({
                        map: mapa,
                        radius: 3000,
                        fillColor: '#AA0000',
                        fillOpacity: 0.2,
                        strokeColor: '#AA0000',
                        strokeOpacity: 0.5,
                        strokeWeight: 2,
                        center: ubicacionLugar
                    });

                    hubs.forEach(hub => {
                        const ubicacionHub = new google.maps.LatLng(hub.lat, hub.lng);
                        const distancia = google.maps.geometry.spherical.computeDistanceBetween(ubicacionLugar, ubicacionHub);
                        const distanciaKm = (distancia / 1000).toFixed(2);

                        const itemDistancia = document.createElement('div');
                        itemDistancia.classList.add('distance-item', distanciaKm <= 3 ? 'green-bg' : 'red-bg');
                        itemDistancia.innerHTML = `<strong>${hub.nombre}</strong> - ${distanciaKm} km`;

                        listaDistancias.appendChild(itemDistancia);

                        // Mostrar ruta entre la ubicación buscada y el hub
                        servicioDirecciones.route({
                            origin: ubicacionLugar,
                            destination: ubicacionHub,
                            travelMode: 'DRIVING'
                        }, (response, status) => {
                            if (status === 'OK') {
                                renderizadorDirecciones.setDirections(response);
                            } else {
                                console.error(`La solicitud de direcciones falló debido a ${status}`);
                            }
                        });
                    });

                    mapa.panTo(ubicacionLugar);
                    mapa.setZoom(14);

                    // Agregar resultado de búsqueda a la lista
                    const itemResultado = document.createElement('div');
                    itemResultado.classList.add('result-item');
                    itemResultado.textContent = lugar.name;
                    itemResultado.addEventListener('click', () => {
                        mapa.panTo(ubicacionLugar);
                        mapa.setZoom(14);
                        marcador.setAnimation(google.maps.Animation.BOUNCE);
                        setTimeout(() => marcador.setAnimation(null), 1500);
                    });
                    listaResultados.appendChild(itemResultado);
                });

                input.value = '';
            });

            document.getElementById('reset-button').addEventListener('click', () => {
                // Reiniciar el mapa y la lista de distancias
                marcadores.forEach(marcador => marcador.setMap(null));
                const listaDistancias = document.getElementById('distance-list');
                listaDistancias.innerHTML = '';
                const listaResultados = document.getElementById('result-list');
                listaResultados.innerHTML = '';
                input.value = '';
                renderizadorDirecciones.set('directions', null);
                mapa.setCenter({ lat: -33.4489, lng: -70.6693 });
                mapa.setZoom(13);

                // Eliminar círculo de búsqueda si existe
                if (circuloBusqueda) {
                    circuloBusqueda.setMap(null);
                }

                // Volver a agregar los marcadores de los hubs
                agregarMarcadoresHubs();
            });
        }

        google.maps.event.addDomListener(window, 'load', inicializarMapa);
    </script>
    <!-- Incluir la API de Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAovSlHVEYWgZf3a_Skux_nwRCcPZUM6rI&libraries=places,geometry"></script>
</body>
</html>
